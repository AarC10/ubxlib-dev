# Introduction
This describes how to go about setting up a \[currently Windows only\] test agent.

Before setting up an agent, you need to decide which instances from [DATABASE.md](DATABASE.md) you intend the agent to support.

# Install Third Party Applications
Install on the agent the third party applications for the instances it will support; the version number of the application that the `ubxlib` code was tested with can usually be found in the `README.md` files for each platform.  Links are provided and, for internal u-blox use, the correct version of each application can be found pre-downloaded in the private repo https://github.com/u-blox/ubxlib_third_party.  Install to the suggested locations if you can; this way you will not have to make any changes to the default settings files generated by `u_settings.py`.

Note: when unzipping a downloaded file make sure to right-click and unblock it **before** unzipping or nothing you extract will be allowed to run.

| Required for             | Application                                   | Link                                              | Installation directory          |
| ------------------------ | --------------------------------------------- | ------------------------------------------------- | ------------------------------- |
| Everything               | `Python`: version 3.8 or later is good; do the "disable path length limit" thing at the end if offered. | https://www.python.org/downloads/ | Anywhere on the path (and install for all users). |
|                          | `RPyC`: no link, just `pip install rpyc`.     |                                                   |                                 |
|                          | `pyserial`: no link, just `pip install pyserial`. |                                               |                                 |
|                          | `psutil`: no link, just `pip install psutil`. |                                                   |                                 |
|                          | `requests`: no link, just `pip install requests`. |                                               |                                 |
|                          | `requests_toolbelt`: no link, just `pip install requests_toolbelt`. |                             |                                 |
|                          | `pylink-square` (NOT just "pylink", that's different!): no link, just `pip install pylink-square`. | |                              |
|                          | `portalocker`: no link, just `pip install portalocker`. |                                         |                                 |
|                          | `Git`: version control, unless you are well versed in `Vim`, suggest installing `notepad++` (see below) first and selecting it as the text editor for Git during installation. | https://git-scm.com/downloads | Anywhere on the path, let the installer choose. |
|                          | `DevCon`: utility to reset USB ports.         | https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/devcon-examples | Anywhere on the path, conventionally copy the files into `C:\Program Files (x86)\utils\DevCon` and add `C:\Program Files (x86)\utils\DevCon\amd64` to the path. |
|                          | `USBSwitchCmd`: to control Cleware USB cutter. | https://www.cleware-shop.de/USB-Cutter/en        | Anywhere on the path, conventionally copy the files into `C:\Program Files (x86)\utils\USBSwitchCmd`. |
| Lint "platform"          | `flexelint`: a *licensed* product that is no longer sold (u-blox has a licensed copy). | https://www.gimpel.com/archive/products.htm | Anywhere on the path, conventionally copy the files into `C:\flexelint` and add `C:\flexelint\bin` to the path. |
|                          | `TDM-GCC-64`: a 64 bit C compiler.            | https://jmeubank.github.io/tdm-gcc/               | `C:\TDM-GCC-64` and *also* add `C:\TDM-GCC-64\bin` to the path. |
|                          | `make`: you are *strongly advised* to use the version at the link; there are other versions of `make` for Windows around that do not work correctly. | http://gnuwin32.sourceforge.net/packages/make.htm | Anywhere on the path, let the installer choose, provided it is *before* what follows. |
|                          | `unxutils`: `rm`, `touch`, `gawk`, etc.       | https://sourceforge.net/projects/unxutils/        | Anywhere on the path *after* the preceding line (conventionally copy the files into `C:\Program Files (x86)\utils\unxutils`), i.e. so that the version of `make` that comes inside this package is ignored.  You will need to add the `usr\local\wbin` sub-directory to the path. |
| Doyxgen                  | `Doxygen`.                                    | https://www.doxygen.nl/index.html                 | Anywhere on the path, let the installer choose. |
| AStyle                   | `AStyle`: *must* be version 3.1; version 3.0 will *not* work. | http://astyle.sourceforge.net/    | Anywhere on the path, conventionally copy the files into `C:\AStyle` and add `C:\AStyle\bin` to the path. |
| PyLint                   | `PyLint`: no link, just `pip install pylint` from a command prompt with administrator privileges. |                                                   |                                 |
| Static size "platform"   | `GCC ARM`: GNU ARM compiler.                  | https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads | `C:/Program Files (x86)/GNU Arm Embedded Toolchain/10 2020-q4-major/bin` |
| No floating point check  | Same as for static size above.                |                                                   |                                 |
| ESP-IDF platform         | None: `u_run_esp_idf.py` does all the work.   |                                                   |                                 |
| nRF5SDK platform, GCC    | `GCC ARM`: as for static size above.          |                                                   |                                 |
|                          | `make`: as for Lint above.                    |                                                   |                                 |
|                          | `nRF5 SDK`.                                   | https://www.nordicsemi.com/Software-and-Tools/Software/nRF5-SDK | `C:\nrf5`         |
|                          | `nRF command-line tools`.                     | https://www.nordicsemi.com/Software-and-Tools/Development-Tools/nRF-Command-Line-Tools) | Anywhere on the path, let the installer choose. |
|                          | `JLink Software and Documentation Pack`.      | https://www.segger.com/downloads/jlink/#J-LinkSoftwareAndDocumentationPack | Anywhere on the path: tick to over-write an existing installation and let the installer choose. |
| nRF5SDK platform, SES    | `Segger Embedded Studio`: IDE; you will also need to run this and activate a \[free\] license to use it with Nordic chips. | https://www.segger.com/products/development-tools/embedded-studio/ | `C:\Program Files\Segger\SEGGER Embedded Studio for ARM 4.52c\bin` |
|                          | `nRF5 SDK`: as for GCC version.               |                                                   |                                 |
|                          | `nRF command-line tools`: as for GCC version. |                                                   |                                 |
|                          | `JLink Software and Documentation Pack`: as for GCC version. |                                    |                                 |
| Zephyr platform          | `nRF Connect`: the kitchen sink; run this, select `Toolchain Manager`, open that and then use it to install the correct version of `nRF Connect`. | https://www.nordicsemi.com/Software-and-Tools/Development-Tools/nRF-Connect-for-desktop | `C:\nrfconnect\v1.4.2`; tell the installer to use `C:\nrfconnect` and it will add the rest. |
|                          | `nRF command-line tools`: as for nRF5SDK GCC. |                                                   |                                 |
|                          | `JLink Software and Documentation Pack`: as for nRF5SDK. |                                        |                                 |
| STM32Cube platform       | `STM32Cube FW F4`: SDK.                       | https://www.st.com/en/embedded-software/stm32cubef4.html | `C:\STM32Cube_FW_F4`     |
|                          | `STM32Cube`: IDE.                             | https://www.st.com/en/development-tools/stm32cubeide.html | `C:\ST\STM32CubeIDE_1.4.0\STM32CubeIDE` |
|                          | Optional: `STLink` utility.                   | https://www.st.com/en/development-tools/stsw-link004.html | Anywhere; conventionally copy the files into `C:\ST\STM32 ST-LINK Utility` and add a shortcut to the `STM32 ST-LINK Utility.exe` executable on the desktop.               |
|                          | Optional: `mfc100.dll`, only needed if the above complains about the lack of it. | https://www.microsoft.com/en-us/download/details.aspx?id=26999 | Anywhere, the installer will choose. |
| Nothing                  | Optional: `u-blox EasyFlash` to update cellular module FW; for those outside u-blox this can be obtained from your u-blox FAE. | https://github.com/u-blox/ubxlib_third_party | Anywhere, conventionally `C:\Program Files (x86)\EasyFlash.vx.y`.             |
|                          | Optional: `notepad++` text editor.            | https://notepad-plus-plus.org/downloads/          | Anywhere, let the installer choose. |
|                          | Optional: `PuTTY` serial terminal.            | https://www.putty.org/                            | Anywhere, let the installer choose. |
|                          | Optional: `Tortoise Git`, a great Git GUI.    | https://tortoisegit.org/                          | Anywhere, let the installer choose. |

# Download Code And Configure The Agent

Create, a directory, e.g. `C:\agent`, in which to store the agent code.

Git clone into it https://github.com/u-blox/ubxlib, or for internal u-blox users Git clone https://github.com/u-blox/ubxlib_priv but into a `ubxlib` sub-directory instead of a `ubxlib_priv` sub-directory.  You should now have `C:\agent\ubxlib`.

Git clone https://github.com/ThrowTheSwitch/Unity into it; you should now have `C:\agent\Unity` also.

Open a command window, with Administrator privileges, `CD` to `C:\agent\ubxlib\port\platform\common\automation` and run `python u_settings.py`.  This will spew out a load of warnings about things not existing and will create two settings files, `settings_v2.json` and `settings_v2_agent_specific.json`, in the directory`C:\Users\<your_username>\.ubx_automation`.  Open `settings_v2_agent_specific.json` in a text editor; if you installed any of the applications above (ignoring ones that are "anywhere on the path") into a directory other than the default, find the original entry in the file and edit it to match the location you used.  Then remove all of the `_FIX_ME` post-fixes in the file using search and replace and save the file.  It is a good idea to make a backup of these files now, in case of accidents.

# Attach Boards

If you have chosen instances for which hardware is required you should now attach that hardware to the agent and check that it is working as expected.

TODO: add detail here.

# Run The Agent

To take the easy route:

- on Windows create the directory you wish to run in, conventionally `C:\agent`, copy the batch file `agent_start.bat` into that directory, open a command prompt in that directory and run `agent_start /?` for further instructions.  You can then use the Windows Task Scheduler to have this batch file run at boot; if you want to avoid the irritating `Terminate batch job (Y/N)?` prompt when CTRL-C is pressed then append `< nul` to the end of the command-line, e.g. `agent_start.bat < nul`.

- on Linux TODO.

If you'd rather do things manually:

Decide where you would like the agent's work to be carried out.  It is important to keep this path short and so it is best to use a `subst`ed drive.  For instance, you might create a directory `C:\agent\work` and then `subst z: C:\agent\work`. If you do not want to use `subst` for some reason then chose a very short directory name off the root, e.g. `C:\w`.

You must also have decided the listening port number that this and other agents in this group of agents will make themselves available to the contoller on (see [MKII.md](MKII.md) for architectural details).  If it is not the default listening port, 17003, then you should add `-p x`, where `x` is the listening port number, to the command-line below.

And finally you need to give the agent a logical name; it is a good idea to use the machine name for this, e.g. `gb-cmb-dt-051`.

You are now ready to run the agent.  In a command window, with Administrator privileges, `CD` to `C:\agent\ubxlib\port\platform\common\automation`.  Command-line help can be obtained with `python u_agent_service.py -h` but an example command-line might be something like:

`python u_agent_service.py -n gb-cmb-dt-051 -u C:\agent\Unity z: 0.0 0.1 0.2 2 3 4 13.0.0 17`

...where the numbers at the end are the space-separated list of instances that the agent supports.  When prompted, let it through the Windows firewall.

Run this as a test and you should see something like:

```
gb-cmb-dt-051: listening on port 17003, working directory "z:", instance(s) supported: 0.0 0.1 0.2 2 3 4 13.0.0 17.
2021-05-04_09:20:06 gb-cmb-dt-051: started, CTRL-C to exit.
```

If you then see:

```
no registry acknowledged
```

...this means that the agent has been unable to locate `rpyc_registry.py`, which should be listening on port 18811 of a machine on the same network.  This is a requirement for [RPyC](https://rpyc.readthedocs.io/) to work (i.e. a single machine somewhere on the same network as the controller and this agent must be running something like `python "C:\Program Files\Python39\Scripts\rpyc_registry.py"`).  This problem should be resolved before you continue.

It is a good idea to do a test run of the controller using this new agent: the controller should find it and be able to execute tests on it.